<div class="page">
  <header class="topbar">
    <div class="brand">
      <div class="logo">RT</div>
      <div>
        <div class="title">Realtime Voice Assistant</div>
        <div class="subtitle">Live transcription + text responses</div>
      </div>
    </div>

    <div class="status" [class.on]="connected">
      <span class="dot"></span>
      <span>{{ connected ? 'Connected' : 'Disconnected' }}</span>
      @if (connected) {
        <span class="pill">{{ stateLabel(state$ | async) }}</span>
      }
    </div>
  </header>

  <main class="grid">
    <section class="panel controls">
      <h3>Controls</h3>

      <label class="label">Input device</label>
      <select class="select"
              [(ngModel)]="selectedDeviceId"
              [disabled]="connected || devicesLoading || !devicesReady">
        @if (devicesLoading) {
          <option [value]="''">Loading devices...</option>
        }
        @for (d of devices; track d.deviceId) {
          <option [value]="d.deviceId">
            {{ d.label || '(device)' }}
          </option>
        }
      </select>

      <hr class="sep" />

      <label class="label" for="resumeInput">Resume / Context</label>
      <textarea id="resumeInput"
                class="textarea"
                rows="6"
                placeholder="Paste your resume or context here..."
                [(ngModel)]="resumeText"
                [disabled]="connected"></textarea>

      <label class="label" for="promptInput">System Prompt</label>
      <textarea id="promptInput"
                class="textarea"
                rows="4"
                placeholder="e.g. You are an interview assistant. Answer as if you are the candidate..."
                [(ngModel)]="systemPrompt"
                [disabled]="connected">
      </textarea>

      <hr class="sep" />

      <label class="label" for="apiKeyInput">OpenAI API Key</label>
      <div class="row" style="gap:8px; align-items:center;">
        <input id="apiKeyInput"
               class="input"
               type="password"
               placeholder="sk-..."
               [(ngModel)]="apiKey"
               (ngModelChange)="apiKeyStatus = 'idle'; apiKeyError = ''"
               [disabled]="connected"
               style="flex:1;" />
        <button class="btn"
                (click)="validateKey()"
                [disabled]="connected || !apiKey.trim() || apiKeyStatus === 'validating'">
          {{ apiKeyStatus === 'validating' ? 'Validating...' : 'Validate' }}
        </button>
      </div>
      @if (apiKeyStatus === 'valid') {
        <div class="hint" style="color:#22c55e;">
          Key is valid
        </div>
      }
      @if (apiKeyStatus === 'invalid') {
        <div class="hint" style="color:#ef4444;">
          {{ apiKeyError }}
        </div>
      }
      <div class="hint">
        Enter your OpenAI API key and validate it before starting.
      </div>

      @if (startError) {
        <div class="hint" style="color:#ef4444;">
          {{ startError }}
        </div>
      }

      <div class="row">
        <button class="btn primary"
                (click)="start()"
                [disabled]="connected || apiKeyStatus !== 'valid' || starting">
          {{ starting ? 'Connecting...' : 'Start' }}
        </button>
        <button class="btn" (click)="stop()" [disabled]="!connected">
          Stop
        </button>
      </div>

      <hr class="sep" />

      <!-- VAD tuning (collapsible) -->
      <div class="collapsible-header" (click)="showVad = !showVad">
        <h4 class="subhead" style="margin:0;">VAD tuning</h4>
        <span class="chevron" [class.open]="showVad">&#9654;</span>
      </div>
      <div class="collapsible-body" [class.open]="showVad">
        <div class="collapsible-inner">
          <div style="padding-top:10px;">
            <label class="label">Threshold: {{ vad.threshold }}</label>
            <input class="range"
                   type="range"
                   min="0"
                   max="1"
                   step="0.05"
                   [(ngModel)]="vad.threshold"
                   [disabled]="connected" />

            <label class="label" style="margin-top:10px;">Prefix padding (ms)</label>
            <input class="input"
                   type="number"
                   min="0"
                   max="2000"
                   step="50"
                   [(ngModel)]="vad.prefixPaddingMs"
                   [disabled]="connected" />

            <label class="label" style="margin-top:10px;">Silence duration (ms)</label>
            <input class="input"
                   type="number"
                   min="200"
                   max="5000"
                   step="100"
                   [(ngModel)]="vad.silenceDurationMs"
                   [disabled]="connected" />

            <div class="row" style="margin-top:10px;">
              <button class="btn" (click)="resetVad()" [disabled]="connected">Reset</button>
            </div>

            <div class="hint">
              If responses cut off, increase <b>Silence duration</b> to 1300-1600ms.
            </div>
          </div>
        </div>
      </div>

      <hr class="sep" />

      <!-- Export (collapsible) -->
      @if (messages$ | async; as msgs) {
        <div class="row" style="gap:8px; margin-top:0;">
          <button class="btn" (click)="exportJson()" [disabled]="!msgs.length">Export JSON</button>
          <button class="btn" (click)="exportTxt()" [disabled]="!msgs.length">Export TXT</button>
          <button class="btn" (click)="copyTranscript()" [disabled]="!msgs.length">Copy</button>
        </div>
      }

      <!-- Debug (collapsible) -->
      <div class="collapsible-header" style="margin-top:12px;" (click)="showDebug = !showDebug">
        <h4 class="subhead" style="margin:0;">Debug</h4>
        <span class="chevron" [class.open]="showDebug">&#9654;</span>
      </div>
      <div class="collapsible-body" [class.open]="showDebug">
        <div class="collapsible-inner">
          <div style="padding-top:8px;">
            <div class="row" style="gap:8px; margin-top:0;">
              <button class="btn" (click)="toggleDebugEnabled()">
                Debug: {{ debugEnabled ? 'On' : 'Off' }}
              </button>

              @if (debug$ | async; as debug) {
                <button class="btn" (click)="clearDebug()" [disabled]="!debug.length">
                  Clear
                </button>
              }
            </div>

            <div class="panel debug">
              @if (debug$ | async; as debug) {
                <div class="debugHeader">
                  <div><b>Realtime Events</b></div>

                  <button class="btn small"
                          (click)="copyDebug(debug)"
                          [disabled]="!debug.length">
                    Copy
                  </button>
                </div>

                <div class="debugBody">
                  @for (e of debug; track e.ts) {
                    <div class="debugRow">
                      <span class="t">{{ e.ts | date:'HH:mm:ss.SSS' }}</span>
                      <span class="k">{{ e.type }}</span>
                      <span class="v">{{ e.summary }}</span>
                    </div>
                  }

                  @if (debug.length === 0) {
                    <div class="empty" style="padding:14px;">
                      No events yet.
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="hint">
        Tip: enable <b>Line In</b> as an input device in Windows Sound settings to select it here.
      </div>
    </section>

    <section class="panel chat">
      <div class="chatHeader">
        <h3>Conversation</h3>
        <div class="small">
          Speak > pause > transcript appears > assistant responds
        </div>
      </div>

      <div class="chatBody" #chatBody>
        @for (m of (messages$ | async); track m.ts) {
          <div class="msg" [class.user]="m.role === 'user'" [class.assistant]="m.role === 'assistant'">
            <div class="meta">
              <span class="badge">{{ m.role === 'user' ? 'You' : 'Assistant' }}</span>
            </div>
            <div class="bubble">{{ m.text }}</div>
          </div>
        }

        @if ((messages$ | async)?.length === 0) {
          <div class="empty">
            <span class="empty-icon">&#127908;</span>
            <div class="empty-title">Ready to listen</div>
            Click <b>Start</b> and speak into your microphone.<br>
            Your transcript and the assistant's reply will appear here.
          </div>
        }
      </div>
    </section>
  </main>

  <footer class="footer">
    Built with Angular + Spring Boot + OpenAI Realtime
  </footer>
</div>
