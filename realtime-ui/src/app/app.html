<div class="page">
  <header class="topbar">
    <div class="brand">
      <div class="logo">RT</div>
      <div>
        <div class="title">Realtime Voice Assistant</div>
        <div class="subtitle">Live transcription + text responses (local)</div>
      </div>
    </div>

    <div class="status" [class.on]="connected">
      <span class="dot"></span>
      <span>{{ connected ? 'Connected' : 'Disconnected' }}</span>
      <span class="pill" *ngIf="connected">{{ stateLabel(state$ | async) }}</span>
    </div>
  </header>

  <main class="grid">
    <section class="panel controls">
      <h3>Controls</h3>

      <label class="label">Input device</label>
      <select class="select"
              [(ngModel)]="selectedDeviceId"
              [disabled]="connected || devicesLoading || !devicesReady">
        <option *ngIf="devicesLoading" [value]="''">Loading devices…</option>

        <option *ngFor="let d of devices" [value]="d.deviceId">
          {{ d.label || '(device)' }}
        </option>
      </select>


      <hr class="sep" />

      <label class="label" for="resumeInput">Resume / Context</label>
      <textarea id="resumeInput"
                class="textarea"
                rows="6"
                placeholder="Paste your resume or context here…"
                [(ngModel)]="resumeText"
                [disabled]="connected"></textarea>

      <label class="label" for="promptInput">System Prompt</label>
      <textarea id="promptInput"
                class="textarea"
                rows="4"
                placeholder="e.g. You are an interview assistant. Answer as if you are the candidate…"
                [(ngModel)]="systemPrompt"
                [disabled]="connected">
      </textarea>

      <div class="row">
        <button class="btn primary" (click)="start()" [disabled]="connected">
          Start
        </button>
        <button class="btn" (click)="stop()" [disabled]="!connected">
          Stop
        </button>
      </div>

      <hr class="sep" />

      <h4 class="subhead">VAD tuning</h4>

      <label class="label">Threshold: {{ vad.threshold }}</label>
      <input class="range"
             type="range"
             min="0"
             max="1"
             step="0.05"
             [(ngModel)]="vad.threshold"
             [disabled]="connected" />

      <label class="label">Prefix padding (ms)</label>
      <input class="input"
             type="number"
             min="0"
             max="2000"
             step="50"
             [(ngModel)]="vad.prefixPaddingMs"
             [disabled]="connected" />

      <label class="label">Silence duration (ms)</label>
      <input class="input"
             type="number"
             min="200"
             max="5000"
             step="100"
             [(ngModel)]="vad.silenceDurationMs"
             [disabled]="connected" />

      <div class="row" style="margin-top:10px;">
        <button class="btn" (click)="resetVad()" [disabled]="connected">Reset</button>
      </div>

      <div class="hint">
        If responses cut off, increase <b>Silence duration</b> to 1300–1600ms.
      </div>

      <ng-container *ngIf="messages$ | async as msgs">
        <div class="row" style="gap:8px; margin-top:12px;">
          <button class="btn" (click)="exportJson()" [disabled]="!msgs.length">Export JSON</button>
          <button class="btn" (click)="exportTxt()" [disabled]="!msgs.length">Export TXT</button>
          <button class="btn" (click)="copyTranscript()" [disabled]="!msgs.length">Copy</button>
        </div>
      </ng-container>

      <div class="row" style="gap:8px; margin-top:12px;">
        <button class="btn" (click)="showDebug = !showDebug">
          {{ showDebug ? 'Hide Debug' : 'Show Debug' }}
        </button>

        <button class="btn" (click)="toggleDebugEnabled()">
          Debug: {{ debugEnabled ? 'On' : 'Off' }}
        </button>

        <ng-container *ngIf="debug$ | async as debug">
          <button class="btn" (click)="clearDebug()" [disabled]="!debug.length">
            Clear
          </button>
        </ng-container>
      </div>

      <div class="panel debug" *ngIf="showDebug">
        <ng-container *ngIf="debug$ | async as debug">
          <div class="debugHeader">
            <div><b>Realtime Events</b></div>

            <button class="btn small"
                    (click)="copyDebug(debug)"
                    [disabled]="!debug.length">
              Copy
            </button>
          </div>

          <div class="debugBody">
            <div class="debugRow" *ngFor="let e of debug">
              <span class="t">{{ e.ts | date:'HH:mm:ss.SSS' }}</span>
              <span class="k">{{ e.type }}</span>
              <span class="v">{{ e.summary }}</span>
            </div>

            <div class="empty" *ngIf="debug.length === 0">
              No events yet.
            </div>
          </div>
        </ng-container>
      </div>

      <div class="hint">
        Tip: enable <b>Line In</b> as an input device in Windows Sound settings to select it here.
      </div>
    </section>

    <section class="panel chat">
      <div class="chatHeader">
        <h3>Conversation</h3>
        <div class="small">
          Speak → pause → transcript appears → assistant responds
        </div>
      </div>

      <div class="chatBody" #chatBody>
        <ng-container *ngFor="let m of (messages$ | async)">
          <div class="msg" [class.user]="m.role === 'user'" [class.assistant]="m.role === 'assistant'">
            <div class="meta">
              <span class="badge">{{ m.role === 'user' ? 'You' : 'Assistant' }}</span>
            </div>
            <div class="bubble">{{ m.text }}</div>
          </div>
        </ng-container>

        <div class="empty" *ngIf="(messages$ | async)?.length === 0">
          Click <b>Start</b> and talk. Your transcript and the assistant reply will show here.
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    Built locally with Angular + Spring Boot + OpenAI Realtime
  </footer>
</div>
